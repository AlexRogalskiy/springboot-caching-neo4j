= springboot-neo4j-caffeine

== Goal

The goal of this project is to implement a simple application that handles restaurants and explore how caching works.
The application has some endpoints to manage restaurants, cities (where the restaurants are located in) and dishes
the restaurants have. We are using https://github.com/ben-manes/caffeine[Caffeine] for caching and https://neo4j.com[Neo4j]
for storage.

image::images/neo4j-ui.png[]

== Caching

The application uses 3 caches: `CITIES`, `RESTAURANTS` and `DISHES`.

The cache is applied on controller level. For instance, if you call `GET /api/restaurants/123` for the first time,
the application will check whether the key `123` is present in the `RESTAURANTS` cache. If not, it must go to DB
in order to get the information about the restaurant (payload), let's say that the payload is
```
{
    "name": "Happy Pizza", "city": {"id": 1, "name": "Berlin"}, "dishes": []
}
```

Before the endpoint finishes and returns the result, the key and its payload are saved in `RESTAURANTS` cache:
```
{
    "123" = {"name": "Happy Pizza", "city": {"id": 1, "name": "Berlin"}, "dishes": []}
}
```

On subsequents calls to `GET /api/restaurants/123` (and as far as the data is not evicted), the application just needs
to go to cache the get the value.

By the way, we've implemented more advanced caching logic as the one presented above like, for example, imagine that you
have a city cached in `CITIES` cache and a new restaurant is created for that city. In this case, the cache of the city
is evicted of `CITIES` (because the list of restaurants in the city changed) and a new cache for the restaurant is put in
RESTAURANTS cache. The same happens when a restaurant is deleted/update or a restaurant dish is added/deleted/updated.

== Start Environment

==== Docker Compose

- Open one terminal

- In `/springboot-neo4j-caffeine` root folder run
----
docker-compose up -d
----

[NOTE]
====
To stop and remove containers, networks, images, and volumes
```
docker-compose down -v
```
====

- Wait a little bit to docker containers be up and healthy. To check it, run
----
docker-compose ps
----

==== Insert some cities, restaurants and dishes in Neo4j

TODO

== Start application using Maven

In `/springboot-neo4j-caffeine` root folder run
----
mvn spring-boot:run
----

== Using application

In order to interact with the application, you can access `Swagger` website: http://localhost:8080/swagger-ui.html

== Neo4j

You can access the UI of Neo4j running in the docker container at http://localhost:7474/browser

== Bug

During the startup you can see a lot of
----
WARN ... o.s.d.n.mapping.Neo4jPersistentProperty : No identity field found for class of type ...
----
It is a bug know by Spring Data Neo4j team: https://jira.spring.io/browse/DATAGRAPH-1076

== TODO

- Add AOP to log whenever the endpoint is called;
- Create a bash script that uses Neo4j API to insert some data.

== Reference
https://graphaware.com/neo4j/2015/09/03/sdn-4-object-model.html